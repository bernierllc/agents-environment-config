#!/bin/bash
# Pre-push git hook for syncing agents and skills

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get the repository root
REPO_ROOT="$(cd "$(dirname "$0")/../.." && pwd)"
SYNC_SCRIPT="$REPO_ROOT/scripts/sync-agents-skills.py"

echo -e "${GREEN}=== Agent & Skill Sync (pre-push) ===${NC}"

# Check skip flag
if [ "${SKIP_SYNC}" = "1" ] || [ "${SKIP_SYNC}" = "true" ]; then
    echo -e "${YELLOW}SKIP_SYNC is set, skipping sync${NC}"
    exit 0
fi

# Check if sync script exists
if [ ! -f "$SYNC_SCRIPT" ]; then
    echo -e "${YELLOW}Warning: Sync script not found at $SYNC_SCRIPT${NC}"
    echo "Continuing with push..."
    exit 0
fi

# Check if Python 3 is available
if ! command -v python3 &> /dev/null; then
    echo -e "${YELLOW}Warning: Python 3 not found, skipping sync${NC}"
    echo "Continuing with push..."
    exit 0
fi

# Run the sync script
echo "Running sync operations..."
if python3 "$SYNC_SCRIPT"; then
    echo -e "${GREEN}✓ Sync completed successfully${NC}"
    
    # Check if there are changes to commit in cursor commands
    cd "$REPO_ROOT"
    if git diff --quiet .cursor/commands/; then
        echo "No cursor command changes to commit"
    else
        echo "Staging cursor command changes..."
        git add .cursor/commands/
        
        # Check if we're in a rebase or merge
        if [ -d ".git/rebase-merge" ] || [ -d ".git/rebase-apply" ] || [ -f ".git/MERGE_HEAD" ]; then
            echo -e "${YELLOW}In rebase/merge, skipping auto-commit${NC}"
        else
            # Only commit if there are staged changes
            if ! git diff --cached --quiet; then
                git commit -m "chore: sync cursor commands from agents/skills" --no-verify
                echo -e "${GREEN}✓ Committed cursor command updates${NC}"
            fi
        fi
    fi
else
    echo -e "${YELLOW}Warning: Sync script encountered errors${NC}"
    echo "Continuing with push anyway..."
fi

echo -e "${GREEN}=== Pre-push sync complete ===${NC}"
exit 0

