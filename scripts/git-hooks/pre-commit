#!/bin/bash
# Pre-commit hook: check script parity and other validations

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get the repository root
REPO_ROOT="$(cd "$(dirname "$0")/../.." && pwd)"

ERRORS=0

echo -e "${GREEN}=== Pre-commit checks ===${NC}"

# --- 1. Check parity between scripts/ and raycast_scripts/ ---
echo -e "\n${GREEN}Checking script parity...${NC}"

# Scripts that MUST exist in both directories
REQUIRED_SCRIPTS=("setup-repo.sh")

for script in "${REQUIRED_SCRIPTS[@]}"; do
    SCRIPTS_PATH="$REPO_ROOT/scripts/$script"
    RAYCAST_PATH="$REPO_ROOT/raycast_scripts/$script"

    if [ -f "$SCRIPTS_PATH" ] && [ ! -f "$RAYCAST_PATH" ]; then
        echo -e "${RED}✗ Missing in raycast_scripts/: $script${NC}"
        echo -e "  Copy from scripts/ or create equivalent"
        ERRORS=$((ERRORS + 1))
    elif [ ! -f "$SCRIPTS_PATH" ] && [ -f "$RAYCAST_PATH" ]; then
        echo -e "${RED}✗ Missing in scripts/: $script${NC}"
        echo -e "  Copy from raycast_scripts/ or create equivalent"
        ERRORS=$((ERRORS + 1))
    elif [ -f "$SCRIPTS_PATH" ] && [ -f "$RAYCAST_PATH" ]; then
        echo -e "${GREEN}✓${NC} $script exists in both directories"
    fi
done

# --- 2. Check that AGENTINFO.md is a template, not project-specific ---
echo -e "\n${GREEN}Checking AGENTINFO.md is a template...${NC}"
AGENTINFO="$REPO_ROOT/AGENTINFO.md"

if [ -f "$AGENTINFO" ]; then
    # Check if it contains the template marker
    if grep -q "REPLACE THIS CONTENT\|REPLACE THE CONTENT" "$AGENTINFO"; then
        echo -e "${GREEN}✓${NC} AGENTINFO.md is a template"
    else
        echo -e "${RED}✗ AGENTINFO.md appears to be project-specific, not a template${NC}"
        echo -e "  This repo is a TEMPLATE. AGENTINFO.md should contain placeholder text."
        echo -e "  Look for 'REPLACE THIS CONTENT' or similar marker."
        ERRORS=$((ERRORS + 1))
    fi
fi

# --- 3. Validate Python scripts syntax ---
echo -e "\n${GREEN}Checking Python syntax...${NC}"
for pyfile in "$REPO_ROOT"/scripts/*.py; do
    if [ -f "$pyfile" ]; then
        if python3 -m py_compile "$pyfile" 2>/dev/null; then
            echo -e "${GREEN}✓${NC} $(basename "$pyfile")"
        else
            echo -e "${RED}✗ Syntax error in $(basename "$pyfile")${NC}"
            ERRORS=$((ERRORS + 1))
        fi
    fi
done

# --- 4. Check shell script syntax ---
echo -e "\n${GREEN}Checking shell script syntax...${NC}"
for shfile in "$REPO_ROOT"/scripts/*.sh; do
    if [ -f "$shfile" ]; then
        if bash -n "$shfile" 2>/dev/null; then
            echo -e "${GREEN}✓${NC} $(basename "$shfile")"
        else
            echo -e "${RED}✗ Syntax error in $(basename "$shfile")${NC}"
            ERRORS=$((ERRORS + 1))
        fi
    fi
done

# --- Summary ---
echo ""
if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}=== Pre-commit failed with $ERRORS error(s) ===${NC}"
    echo -e "Fix the issues above before committing."
    exit 1
else
    echo -e "${GREEN}=== All pre-commit checks passed ===${NC}"
    exit 0
fi
